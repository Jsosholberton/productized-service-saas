// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============= USER & AUTH =============

model User {
  id        String   @id @default(cuid())
  clerkId   String   @unique
  email     String   @unique
  role      Role     @default(CLIENT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  projects       Project[]
  subscriptions  Subscription[]
  notifications  Notification[]

  @@index([clerkId])
  @@index([role])
}

enum Role {
  CLIENT
  ADMIN
}

// ============= PROJECT & SCOPE =============

model Project {
  id               String   @id @default(cuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  title            String
  description      String   @db.Text
  status           ProjectStatus @default(PENDING)
  
  // Pricing
  basePrice        Int      // cents (e.g., 1000 = $10.00)
  totalPrice       Int
  features         Feature[]
  
  // Scope Lock
  scopeLocked      Boolean  @default(false)
  scopeLockedAt    DateTime?
  
  // Payment
  transaction      Transaction?
  
  // Maintenance
  subscription     Subscription?
  
  // Delivery
  deliveryFile     String?  // S3 URL or file path
  videoWalkthrough String?  // Loom/YouTube link
  deliveredAt      DateTime?
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([userId])
  @@index([status])
}

enum ProjectStatus {
  PENDING         // Waiting for payment
  PAID            // Payment approved, awaiting development
  IN_DEVELOPMENT  // Work in progress
  REVIEW          // Client review phase
  DELIVERED       // Project delivered
  CANCELLED       // Project cancelled
}

// ============= FEATURES (Scope) =============

model Feature {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  name        String   // e.g., "User Authentication"
  description String   @db.Text
  estimatedHours Int   // Estimated dev hours
  confirmed   Boolean  @default(false) // User checked this feature
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([projectId])
}

// ============= PAYMENTS (Wompi Integration) =============

model Transaction {
  id              String   @id @default(cuid())
  projectId       String   @unique
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  wompiId         String   @unique // Wompi transaction ID
  reference       String   @unique // Unique reference for user (e.g., PRJ-123ABC)
  
  amountInCents   Int      // Total amount in cents
  currency        String   @default("COP")
  
  // Tax calculations
  subtotal        Int
  ivaTax          Int      @default(0)    // IVA (19% in Colombia)
  reteFuente      Int      @default(0)    // Retención en la fuente
  
  wompiStatus     WompiStatus @default(PENDING)
  paymentMethod   String?  // PSE, CARD, NEQUI, etc.
  
  // Integrity & Security
  integritySignature String? // SHA256 signature from Wompi
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  approvedAt      DateTime?

  @@index([projectId])
  @@index([wompiId])
  @@index([reference])
  @@index([wompiStatus])
}

enum WompiStatus {
  PENDING     // Waiting for payment
  APPROVED    // Payment successful
  DECLINED    // Payment rejected
  VOIDED      // Payment cancelled
  ERROR       // Payment error
}

// ============= SUBSCRIPTIONS (Upsell) =============

model Subscription {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  projectId       String   @unique
  project         Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  type            SubscriptionType @default(MAINTENANCE)
  monthlyPrice    Int      // Price in cents per month
  
  status          SubscriptionStatus @default(ACTIVE)
  billingCycle    Int      @default(1) // Current billing cycle
  
  nextBillingDate DateTime
  cancellationDate DateTime?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([projectId])
  @@index([status])
}

enum SubscriptionType {
  MAINTENANCE     // Hosting + bug fixes + 1 change/month
  PRIORITY_SUPPORT // Faster turnaround (add-on)
  DEDICATED_DEVELOPER // Dedicated resource
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
}

// ============= NOTIFICATIONS =============

model Notification {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type      NotificationType
  title     String
  message   String   @db.Text
  read      Boolean  @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([read])
}

enum NotificationType {
  QUOTE_READY     // Cotización lista
  PAYMENT_SUCCESS // Pago procesado
  DEVELOPMENT_START // Desarrollo iniciado
  DELIVERY_READY  // Listo para descargar
  MAINTENANCE_DUE // Mantenimiento próximo
}
